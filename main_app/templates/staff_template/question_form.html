{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <form method="POST" action="">
            {% csrf_token %}
            <div class="row">
                <!-- Question Card -->
                <div class="col-md-12">
                    <div class="card card-primary">
                        <div class="card-header"><h3 class="card-title">New Question</h3></div>
                        <div class="card-body">
                            
                            <!-- Display any non-field errors for the main form -->
                            {% if question_form.non_field_errors %}
                                <div class="alert alert-danger">{{ question_form.non_field_errors }}</div>
                            {% endif %}

                            <div class="form-group">
                                <label>Question Text</label>
                                {{ question_form.text }}
                                {% if question_form.text.errors %}<div class="text-danger mt-1">{{ question_form.text.errors }}</div>{% endif %}
                            </div>
                            <div class="form-group">
                                <label>Marks for this Question</label>
                                {{ question_form.marks }}
                                {% if question_form.marks.errors %}<div class="text-danger mt-1">{{ question_form.marks.errors }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Choices Card -->
                <div class="col-md-12">
                    <div class="card card-success">
                        <div class="card-header"><h3 class="card-title">Answer Choices</h3></div>
                        <div class="card-body">
                            {{ choice_formset.management_form }}
                            
                            <!-- THIS IS THE CRITICAL FIX - IT WILL SHOW THE HIDDEN ERROR -->
                            {% if choice_formset.non_form_errors %}
                                <div class="alert alert-danger">
                                    <strong>Please correct the following issue:</strong>
                                    <ul class="mb-0">
                                    {% for error in choice_formset.non_form_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            
                            <p class="text-muted">Enter at least 2 answer choices below and check the box for the correct answer.</p>
                            
                            {% for form in choice_formset %}
                                <div class="form-row align-items-center mb-2 p-2 border-bottom">
                                    {{ form.id }}
                                    <div class="col-sm-8">
                                        {{ form.text }}
                                        {% if form.text.errors %}<div class="text-danger mt-1">{{ form.text.errors }}</div>{% endif %}
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check">
                                            {{ form.is_correct }}
                                            <label class="form-check-label">Is Correct?</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-12">
                     <div class="card-footer bg-white">
                        <button type="submit" class="btn btn-primary">Save Question</button>
                        <a href="{% url 'quiz_detail' quiz.id %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
    $(document).ready(function(){
        $('input[type="text"], textarea, select').addClass('form-control');
        $('input[type="checkbox"]').addClass('form-check-input');
    });
</script>
{% endblock custom_js %}